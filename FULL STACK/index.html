<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WASAC Water Billing System— Modern UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">WASAC Water Billing System—</a>
      <div>
        <button id="logout" class="btn btn-outline-light btn-sm d-none">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div id="auth-area" class="row justify-content-center mt-5">
      <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Sign in</h5>
            <form id="login-form">
              <div class="mb-2">
                <input class="form-control" name="username" placeholder="Username" required>
              </div>
              <div class="mb-2">
                <input class="form-control" name="password" type="password" placeholder="Password" required>
              </div>
              <div class="d-grid">
                <button class="btn btn-primary">Sign in</button>
              </div>
            </form>
            <hr>
            <small class="text-muted">Need an account? Use the Register button to create one.</small>
            <div class="d-grid mt-2">
              <button id="register-btn" class="btn btn-outline-secondary">Register (create user)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="app-area" class="row" style="display: none;">
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Add Owner</h5>
            <form id="owner-form">
              <div class="mb-2">
                <input class="form-control" name="fname" placeholder="First name" required>
              </div>
              <div class="mb-2">
                <input class="form-control" name="lname" placeholder="Last name" required>
              </div>
              <div class="mb-2">
                <input class="form-control" name="address" placeholder="Address">
              </div>
              <div class="mb-2">
                <input class="form-control" name="contact" placeholder="Contact">
              </div>
              <button class="btn btn-primary w-100">Create Owner</button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Add Bill</h5>
            <form id="bill-form">
              <div class="mb-2">
                <select class="form-select" name="owner_id" id="owner-select"></select>
              </div>
              <div class="mb-2">
                <input class="form-control" name="prev_reading" type="number" placeholder="Previous reading" required>
              </div>
              <div class="mb-2">
                <input class="form-control" name="pres_reading" type="number" placeholder="Present reading" required>
              </div>
              <div class="mb-2">
                <input class="form-control" name="price" type="number" step="0.01" placeholder="Price" required>
              </div>
              <button class="btn btn-success w-100">Add Bill</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">Recent Bills <button id="refresh" class="btn btn-sm btn-outline-primary">Refresh</button></h5>
            <div class="table-responsive">
              <table class="table table-striped" id="bills-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Owner</th>
                    <th>Prev</th>
                    <th>Pres</th>
                    <th>Consumption</th>
                    <th>Price</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const apiBase = './api.php?path=';

    // Auth helpers
    function setToken(t) { localStorage.setItem('wb_token', t); }
    function getToken() { return localStorage.getItem('wb_token'); }
    function clearToken() { localStorage.removeItem('wb_token'); }

    async function apiFetch(path, opts = {}) {
      opts.headers = opts.headers || {};
      opts.headers['Content-Type'] = opts.headers['Content-Type'] || 'application/json';
      const token = getToken();
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(apiBase + path, opts);
      if (res.status === 401) {
        // token invalid/expired - force logout
        logout();
        throw new Error('Unauthorized');
      }
      return res;
    }

    async function fetchOwners() {
      const res = await apiFetch('owners');
      return res.json();
    }

    async function fetchBills() {
      const res = await apiFetch('bills');
      return res.json();
    }

    async function populateOwners() {
      const owners = await fetchOwners();
      const select = document.getElementById('owner-select');
      select.innerHTML = '';
      owners.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = `${o.lname}, ${o.fname}`;
        select.appendChild(opt);
      });
    }

    async function populateBills() {
      const bills = await fetchBills();
      const tbody = document.querySelector('#bills-table tbody');
      tbody.innerHTML = '';
      bills.forEach((b) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.lname}, ${b.fname}</td>
          <td>${b.prev_reading}</td>
          <td>${b.pres_reading}</td>
          <td>${b.consumption ?? (b.pres_reading - b.prev_reading)}</td>
          <td>${Number(b.price).toFixed(2)}</td>
          <td>${b.date}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('owner-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      try {
        const res = await apiFetch('owners', { method: 'POST', body: JSON.stringify(payload) });
        if (res.ok) {
          e.target.reset();
          await populateOwners();
        } else {
          const err = await res.json();
          alert('Failed to create owner: ' + (err.error || res.statusText));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    document.getElementById('bill-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      try {
        const res = await apiFetch('bills', { method: 'POST', body: JSON.stringify(payload) });
        if (res.ok) {
          e.target.reset();
          await populateBills();
        } else {
          const err = await res.json();
          alert('Failed to add bill: ' + (err.error || res.statusText));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    document.getElementById('refresh').addEventListener('click', async () => {
      await populateOwners();
      await populateBills();
    });

    // Login / register / logout handling
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      try {
        const res = await fetch(apiBase + 'login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const err = await res.json();
          alert('Login failed: ' + (err.error || res.statusText));
          return;
        }
        const data = await res.json();
        setToken(data.token);
        showApp();
      } catch (err) {
        alert('Login error: ' + err.message);
      }
    });

    document.getElementById('register-btn').addEventListener('click', async () => {
      const username = prompt('Choose a username (admin):', 'admin');
      if (!username) return;
      const password = prompt('Choose a password:');
      if (!password) return;
      try {
        const res = await fetch(apiBase + 'register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password, display_name: username }) });
        if (res.ok) {
          alert('User created — please sign in');
        } else {
          const err = await res.json();
          alert('Register failed: ' + (err.error || res.statusText));
        }
      } catch (err) {
        alert('Register error: ' + err.message);
      }
    });

    document.getElementById('logout').addEventListener('click', () => logout());

    function logout() {
      clearToken();
      document.getElementById('auth-area').style.display = '';
      document.getElementById('app-area').style.display = 'none';
      document.getElementById('logout').classList.add('d-none');
    }

    function showApp() {
      document.getElementById('auth-area').style.display = 'none';
      document.getElementById('app-area').style.display = '';
      document.getElementById('logout').classList.remove('d-none');
      populateOwners();
      populateBills();
    }

    // Auto-show app if token exists
    (async () => {
      if (getToken()) {
        try {
          showApp();
        } catch (e) {
          logout();
        }
      }
    })();
  </script>
</body>
</html>